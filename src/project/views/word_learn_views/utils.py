from enum import Enum
from random import choices
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from project.db.models.words import UserWordModelManager


MAX_RATING = 15.0


class GameLevel(int, Enum):
    """Game Levels
    ÐÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¸Ð¿Ð¾Ð² Ð¸Ð³Ñ€Ñ‹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° Ð¸Ð·ÑƒÑ‡Ð°ÐµÐ¼Ð¾Ð³Ð¾ ÑÐ»Ð¾Ð²Ð°
    """

    def __new__(cls, *args):
        obj = int.__new__(cls, args[0])
        obj._value_, obj.info_btn = args
        obj.index = obj._value_ - 1
        return obj

    # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð° Ð¼ÐµÐ½ÑŒÑˆÐµ LEVEL_1, Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð³Ñ€Ð° Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ
    # "Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´ ÑÐ»Ð¾Ð²Ð°" - Ð¸Ð³Ñ€Ð° Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
    LEVEL_1 = 1, 'ðŸ‘‡ Ð’Ð«Ð‘Ð•Ð Ð˜ Ð²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´'
    # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð° Ð±Ð¾Ð»ÑŒÑˆÐµ LEVEL_1 Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ LEVEL_2, Ñ‚Ð¾ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹ Ð´Ð²Ð° Ñ‚Ð¸Ð¿Ð° Ð¸Ð³Ñ€Ñ‹,
    # Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ, Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐ¹ Ð¾Ñ‚ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° ÑÐ»Ð¾Ð²Ð°. Ð§ÐµÐ¼ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð°, Ñ‚ÐµÐ¼ Ñ€ÐµÐ¶Ðµ
    # Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ð¾ÑÐ²Ð»ÑÑ‚ÑŒÑÑ Ð¸Ð³Ñ€Ð° Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸, Ð½Ð¾ Ñ‡Ð°Ñ‰Ðµ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ - (Ð’Ð²ÐµÐ´Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´ ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾)
    # ÐÐ° Ð²Ñ‚Ð¾Ñ€Ð¾Ð¼ ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð²ÑÐµ Ñ‚Ð°ÐºÐ¶Ðµ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ñ‹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð°, Ð½Ð¾ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¸Ñ… Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ð²ÐµÑÑ‚Ð¸ Ð² Ñ‡Ð°Ñ‚.
    LEVEL_2 = 2, 'âœï¸ ÐÐ°Ð¹Ð´Ð¸ Ð¸ Ð’Ð’Ð•Ð”Ð˜ Ð²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´'
    # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð° Ð±Ð¾Ð»ÑŒÑˆÐµ LEVEL_2 Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ LEVEL_3, Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ÑÑ Ð¸Ð³Ñ€Ñ‹ Ð²Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð¸
    # Ñ‚Ñ€ÐµÑ‚ÑŒÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ, Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐ¹ Ð¾Ñ‚ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° ÑÐ»Ð¾Ð²Ð°.
    # ÐÐ° Ñ‚Ñ€ÐµÑ‚ÑŒÐµÐ¼ ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð². ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÑÐ¿Ð¾Ð¼Ð½Ð¸Ñ‚ÑŒ Ð¸ Ð²Ð²ÐµÑÑ‚Ð¸ ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾.
    LEVEL_3 = 3, 'âœï¸ Ð’Ð’Ð•Ð”Ð˜ Ð²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´'
    # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð° Ð±Ð¾Ð»ÑŒÑˆÐµ LEVEL_3 Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ LEVEL_4, Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ÑÑ Ð¸Ð³Ñ€Ñ‹ Ñ‚Ñ€ÐµÑ‚ÑŒÐµÐ³Ð¾ Ð¸
    # Ñ‡ÐµÑ‚Ð²ÐµÑ€Ñ‚Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ, Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐ¹ Ð¾Ñ‚ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° ÑÐ»Ð¾Ð²Ð°.
    # ÐÐ° Ñ‡ÐµÑ‚Ð²ÐµÑ€Ñ‚Ð¾Ð¼ ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð². Ð‘ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð°ÑƒÐ´Ð¸Ð¾-Ð¾Ð·Ð²ÑƒÑ‡ÐºÐ° ÑÐ»Ð¾Ð²Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð½ÑƒÐ¶Ð½Ð¾
    # Ð¿Ñ€Ð¾ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ Ð¸ Ð²Ð²ÐµÑÑ‚Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚
    LEVEL_4 = 4, 'âœï¸ ÐŸÑ€Ð¾ÑÐ»ÑƒÑˆÐ°Ð¹ Ð°ÑƒÐ´Ð¸Ð¾ Ð¸ Ð²Ð²ÐµÐ´Ð¸ Ð²ÐµÑ€Ð½Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾'
    # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð° Ð±Ð¾Ð»ÑŒÑˆÐµ LEVEL_4 Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ LEVEL_5, Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ÑÑ Ð¸Ð³Ñ€Ñ‹ Ñ‡ÐµÑ‚Ð²ÐµÑ€Ñ‚Ð¾Ð³Ð¾ Ð¸
    # Ð¿ÑÑ‚Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ, Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐ¹ Ð¾Ñ‚ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° ÑÐ»Ð¾Ð²Ð°.
    # ÐÐ° Ð¿ÑÑ‚Ð¾Ð¼ ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð². Ð‘ÑƒÐ´ÐµÑ‚ Ð¿Ñ€ÐµÐ»Ð¾Ð¶ÐµÐ½Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð½ÑƒÐ¶Ð½Ð¾
    # Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ ÑÐ°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ Ð½Ð°Ð±Ñ€Ð°Ð² Ñ‚ÐµÐºÑÑ‚ Ð² Ñ‡Ð°Ñ‚.
    LEVEL_5 = 5, 'âœï¸ Ð’Ð’Ð•Ð”Ð˜ Ð²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ'
    # Ð•ÑÐ»Ð¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÑÐ»Ð¾Ð²Ð° Ð±Ð¾Ð»ÑŒÑˆÐµ LEVEL_5 Ð¸ Ð¼ÐµÐ½ÑŒÑˆÐµ LEVEL_6, Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‚ÑÑ Ð¸Ð³Ñ€Ñ‹ Ð¿ÑÑ‚Ð¾Ð³Ð¾ Ð¸
    # ÑˆÐµÑÑ‚Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ, Ð·Ð°Ð²Ð¸ÑÑÑ‰ÐµÐ¹ Ð¾Ñ‚ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° ÑÐ»Ð¾Ð²Ð°.
    # ÐÐ° ÑˆÐµÑÑ‚Ð¾Ð¼ ÑƒÑ€Ð¾Ð²Ð½Ðµ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð². Ð‘ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð°ÑƒÐ´Ð¸Ð¾-Ð¾Ð·Ð²ÑƒÑ‡ÐºÐ° Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð½ÑƒÐ¶Ð½Ð¾
    # Ð¿Ñ€Ð¾ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ Ð¸ Ð²Ð²ÐµÑÑ‚Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚
    LEVEL_6 = 6, 'âœï¸ ÐŸÑ€Ð¾ÑÐ»ÑƒÑˆÐ°Ð¹ Ð°ÑƒÐ´Ð¸Ð¾ Ð¸ Ð²Ð²ÐµÐ´Ð¸ Ð²ÐµÑ€Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ'
    LAST_LEVEL = 7, 'âœï¸ Ð’Ð’Ð•Ð”Ð˜ Ð²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´'  # Ð¤Ð¸ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð²ÐµÑ€Ñ…Ð½ÐµÐ¹ Ð¿Ð»Ð°Ð½ÐºÐ¸ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð°

    @classmethod
    def get_weights(cls, rating: float) -> list[float]:
        weights: list[float] = [0.0] * len(GameLevel)
        if rating < 2.0:
            weights[GameLevel.LEVEL_1.index] = 0.66
            weights[GameLevel.LEVEL_4.index] = 0.34
        elif 2.0 <= rating <= 4.0:
            weights[GameLevel.LEVEL_2.index] = 0.66
            weights[GameLevel.LEVEL_4.index] = 0.34
        elif 4.0 <= rating <= 6.0:
            weights[GameLevel.LEVEL_3.index] = 0.66
            weights[GameLevel.LEVEL_4.index] = 0.34
        elif 6.0 <= rating <= 9.0:
            weights[GameLevel.LEVEL_3.index] = 0.34
            weights[GameLevel.LEVEL_4.index] = 0.66
        elif 9.0 <= rating <= 12.0:
            weights[GameLevel.LEVEL_5.index] = 1
        elif 12.0 <= rating:
            weights[GameLevel.LEVEL_6.index] = 0.40
            weights[GameLevel.LEVEL_5.index] = 0.40
            weights[GameLevel.LEVEL_3.index] = 0.20
        return weights

    @classmethod
    def choose_game_level(cls, rating: float) -> 'GameLevel':
        weights = GameLevel.get_weights(rating)
        return choices(list(cls), weights, k=1)[0]

    async def add_rating(self, words: 'UserWordModelManager') -> None:
        await words.update_many([{'$set': {'rating': {'$min': [MAX_RATING, {'$add': ['$rating', 1]}]}}}])

    async def sub_rating(self, words: 'UserWordModelManager') -> None:
        await words.update_many([{'$set': {'rating': {'$max': [0, {'$add': ['$rating', -2]}]}}}])

    @staticmethod
    def compute_percent(rating: float) -> int:
        return min(int(rating / MAX_RATING * 100), 100)
